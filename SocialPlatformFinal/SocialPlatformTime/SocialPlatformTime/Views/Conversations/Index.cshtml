@model IEnumerable<SocialPlatformTime.Models.Conversation>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    var currentUserId = UserManager.GetUserId(User);
}

<div class="list-group shadow-sm">
    @foreach (var conv in Model)
    {
        // Preluăm ultimul mesaj pentru preview
        var lastMessage = conv.Messages?.OrderByDescending(m => m.dateTime).FirstOrDefault();

        string displayTitle;
        string avatarName;

        if (conv.Group != null)
        {
            // Dacă e grup, afișăm numele grupului
            displayTitle = conv.Group.Name;
            avatarName = displayTitle;
        }
        else
        {
            // Dacă e 1-la-1, căutăm în UserConversations partenerul (cel care nu sunt eu)
            var partner = conv.UserConversations?
            .FirstOrDefault(uc => uc.ApplicationUserId != currentUserId)?
            .ApplicationUser;

            displayTitle = partner != null ? (partner.FirstName + " " + partner.LastName).Trim() : "Notițe proprii";

            // Dacă nu are nume setat, folosim UserName
            if (string.IsNullOrEmpty(displayTitle))
            {
                displayTitle = partner?.UserName ?? "Me";
            }

            avatarName = partner?.UserName ?? "Me";
        }

        <a asp-controller="Conversations" asp-action="Show" asp-route-id="@conv.Id" class="list-group-item list-group-item-action border-start-0 border-end-0 border-top-0 py-3">
            <div class="d-flex align-items-center">
                <img src="https://ui-avatars.com/api/?name=@avatarName&background=random&size=128"
                     class="rounded-circle me-3" width="50" height="50" style="object-fit: cover;">

                <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold">@displayTitle</h6>
                        <small class="text-muted">
                            @lastMessage?.dateTime.ToString("HH:mm")
                        </small>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <p class="mb-0 text-muted small text-truncate" style="max-width: 250px;">
                            @if (lastMessage != null)
                            {
                                if (lastMessage.ApplicationUserId == currentUserId)
                                {
                                    <span class="fw-bold text-dark">Tu: </span>
                                }
                                @lastMessage.Content
                            }
                            else
                            {
                                <span class="fst-italic">Conversație nouă...</span>
                            }
                        </p>

                        @if (lastMessage != null && !lastMessage.IsRead && lastMessage.ApplicationUserId != currentUserId)
                        {
                            <span class="badge bg-primary rounded-pill" style="width: 10px; height: 10px; padding: 0;">&nbsp;</span>
                        }
                    </div>
                </div>
            </div>
        </a>
    }
</div>