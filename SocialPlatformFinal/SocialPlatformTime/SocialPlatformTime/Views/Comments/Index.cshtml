@model IEnumerable<SocialPlatformTime.Models.Comment>

<br />
<h2 class="text-center">COMMENTS</h2>
<br />

@if (ViewBag.Message != null)
{
    <h2 class="alert alert-success p-3 rounded-3 text-center mb-5">
        @ViewBag.Message
    </h2>
}

<br />

<!-- Formular pentru adăugare comentariu -->
@if (ViewBag.EsteLogat == true)
{
    <form asp-controller="Comments" asp-action="New" method="post">
        <input type="hidden" name="PostId" value="@ViewBag.PostId" />

        <textarea name="CommentBody" class="form-control" rows="3"></textarea>

        @* Afișare eroare pentru CommentBody *@
        <span class="text-danger">
            @ViewData.ModelState["CommentBody"]?.Errors.FirstOrDefault()?.ErrorMessage
        </span>

        @* Afișare erori generale *@
        @if (!ViewData.ModelState.IsValid && ViewData.ModelState[""] != null)
        {
            <div class="alert alert-danger mt-2">
                @foreach (var error in ViewData.ModelState[""]?.Errors ?? Enumerable.Empty<Microsoft.AspNetCore.Mvc.ModelBinding.ModelError>())
                {
                    <div>@error.ErrorMessage</div>
                }
            </div>
        }

        <button type="submit" class="btn btn-primary mt-2">Add a comment</button>
    </form>
}
<br />


@foreach (var comm in Model)  
{
    <div class="border rounded p-3 mb-3">
        <p><strong>Time:</strong> @comm.Date</p>
        @if (comm.EditedDate.HasValue)
        {
            <p class="text-muted small">
                <em>Edited: @comm.EditedDate.Value</em>
            </p>
        }
        <p><strong>User:</strong> @comm.ApplicationUser?.UserName</p>
        <p><strong>Comment:</strong> @comm.CommentBody</p>


        @* Afisare eticheta sentiment - vizibila doar pentru Admin *@
        @if (ViewBag.EsteAdmin == true && comm.SentimentLabel != null)
        {
            var badgeClass = comm.SentimentLabel switch
            {
                "positive" => "bg-success",
                "negative" => "bg-danger",
                _ => "bg-secondary"
            };
            var sentimentIcon = comm.SentimentLabel switch
            {
                "positive" => "bi-emoji-smile",
                "negative" => "bi-emoji-frown",
                _ => "bi-emoji-neutral"
            };

            <span class="badge @badgeClass ms-2">
                <i class="bi @sentimentIcon"></i>
                @comm.SentimentLabel
                (@(comm.SentimentConfidence?.ToString("P0")))
            </span>
        }
        else if (ViewBag.EsteAdmin == true)
        {
            <span class="badge bg-warning ms-2">No sentiment analyzed</span>
        }


        <div class="d-flex gap-2">
            @if (ViewBag.EsteLogat == true && comm.ApplicationUserId == ViewBag.UserCurent)
            {
                <a class="btn btn-outline-primary btn-sm" asp-controller="Comments" asp-action="Edit" asp-route-id="@comm.Id">
                    <i class="bi bi-pencil-square"></i> Edit
                </a>

                <form asp-action="Delete" asp-controller="Comments" method="post" class="d-inline">
                    <input type="hidden" name="Id" value="@comm.Id" />
                    <button type="submit"
                            class="btn btn-sm btn-danger"
                            onclick="return confirm('Are you sure you want to delete this comment?');">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            }
            else if (ViewBag.EsteLogat == true && ViewBag.EsteAdmin == true)
            {
                <form asp-action="Delete" asp-controller="Comments" method="post" class="d-inline">
                    <input type="hidden" name="Id" value="@comm.Id" />
                    <button type="submit"
                            class="btn btn-sm btn-danger"
                            onclick="return confirm('Are you sure you want to delete this comment?');">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            }
        </div>
    </div>
}