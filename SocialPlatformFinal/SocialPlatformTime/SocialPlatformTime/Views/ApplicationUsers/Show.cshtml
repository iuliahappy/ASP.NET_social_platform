@* @using System.Linq *@
@using SocialPlatformTime.Models


@{
    ViewData["Title"] = "User Profile";
    var user = ViewBag.User;
    bool iFollow = ViewBag.IFollow;
    bool followsMe = ViewBag.FollowsMe;
    bool isCurrentUser = ViewBag.IsCurrentUser;
}

@if (TempData["message"] != null)
{
    <div class="alert @TempData["messageType"]">
        @TempData["message"]
    </div>
}

<div class="card mb-4">
    <div class="card-body">
        <h2>@user.UserName</h2>

        <p><strong>Email:</strong> @user.Email</p>
        <p><strong>First Name:</strong> @user.FirstName</p>
        <p><strong>Last Name:</strong> @user.LastName</p>
        @if (!string.IsNullOrEmpty(user.Image))
        {
            <img src="@user.Image"
                 class="rounded-circle mb-3"
                 style="width:150px;height:150px;object-fit:cover;" />
        }

        @if (!string.IsNullOrEmpty(user.ProfileDescription))
        {
            <p class="mt-3">@user.ProfileDescription</p>
        }
        @if (isCurrentUser)
        {
            <a class="btn btn-outline-secondary"
               asp-action="Edit"
               asp-route-id="@user.Id">
                Edit Profile
            </a>
            <a class="btn btn-outline-primary"
               asp-controller="Posts"
                asp-action="New">
                New Post
            </a>

            <a class="btn btn-outline-warning"
               asp-controller="SavedPosts"
               asp-action="Index">
                <i class="bi bi-bookmark-fill"></i> Saved Posts
            </a>

            ////// afișăm lisa de urmăritori și urmăriți
            var followers = ViewBag.FollowersList as List<ApplicationUser> ?? new List<ApplicationUser>();
            var following = ViewBag.FollowingList as List<ApplicationUser> ?? new List<ApplicationUser>();

            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#followersCollapse">
                    Followers (@followers.Count)
                </button>
                <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#followingCollapse">
                    Following (@following.Count)
                </button>
            </div>

            <div class="collapse mb-3" id="followersCollapse">
                <div class="card card-body">
                    @if (!followers.Any())
                    {
                        <span class="text-muted">No followers</span>
                    }
                    else
                    {
                        <ul class="list-group">
                            @foreach (var u in followers)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>@u.UserName</span>
                                    <a class="btn btn-sm btn-outline-secondary" asp-controller="ApplicationUsers" asp-action="Show" asp-route-id="@u.Id">
                                        View profile
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>

            <div class="collapse mb-3" id="followingCollapse">
                <div class="card card-body">
                    @if (!following.Any())
                    {
                        <span class="text-muted">Not following anyone</span>
                    }
                    else
                    {
                        <ul class="list-group">
                            @foreach (var u in following)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>@u.UserName</span>
                                    <a class="btn btn-sm btn-outline-secondary" asp-controller="ApplicationUsers" asp-action="Show" asp-route-id="@u.Id">
                                        View profile
                                    </a>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>            ///
        }
    </div>
</div>



    @if (ViewBag.ShowFollowSystem && !isCurrentUser)
    {
        <form method="post"
              asp-action="ToggleFollow"
              asp-route-id="@user.Id">
            <button class="btn @(iFollow ? "btn-outline-danger" : "btn-primary")">
                @(iFollow ? "Unfollow" : "Follow")
            </button>
        </form>

        <div class="mt-2">
            @if (iFollow && followsMe)
            {
                <span class="badge bg-success">Mutual following</span>
            }
            else if (iFollow)
            {
                <span class="badge bg-primary">You follow this user</span>
            }
            else if (followsMe)
            {
                <span class="badge bg-secondary">Follows you</span>
            }

            @{
                var pendingRequests = ViewBag.PendingRequests as List<FollowRequest>;
                var currUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                bool hasPending = pendingRequests != null &&
                pendingRequests.Any(r => r.FollowerId == currUserId && r.FollowingId == user.Id);
            }

            @if (hasPending)
            {
                <div class="mt-1">
                    <span class="badge bg-warning text-dark">Follow request pending</span>
                </div>
            }
        </div>
    }


@if (isCurrentUser)
{
    var pendingRequests = ViewBag.PendingRequests as List<FollowRequest>;
    if (pendingRequests != null && pendingRequests.Count > 0)
    {
        <hr />
        <h4>Pending follow requests</h4>
        <ul class="list-group mb-3">
            @foreach (var req in pendingRequests)
            {
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>@req.Follower.UserName</span>
                    <div>
                        <form method="post"
                              asp-action="RespondFollow"
                              asp-route-requestId="@req.Id"
                              asp-route-decision="accept"
                              class="d-inline">
                            <button class="btn btn-sm btn-success">Accept</button>
                        </form>
                        <form method="post"
                              asp-action="RespondFollow"
                              asp-route-requestId="@req.Id"
                              asp-route-decision="reject"
                              class="d-inline ms-2">
                            <button class="btn btn-sm btn-outline-danger">Reject</button>
                        </form>
                    </div>
                </li>
            }
        </ul>
    }
}





<hr />

<h3>@user.UserName's Posts</h3>

@if ((bool)ViewBag.CanViewFullProfile)
{
    @if (user.Posts == null || user.Posts.Count == 0)
    {
        <p>No posts yet.</p>
    }
    else
    {
        foreach (var post in user.Posts)
        {
            <partial name="PostInfo" model="post" />
        }
    }
}
else
{
    <div class="alert alert-info">
        This profile is private.
    </div>
}
